name: Cypress E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2] # Run tests in parallel using 2 instances
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          record: true
          parallel: true
          group: 'E2E Tests'
          tag: ${{ github.event_name }}
        env:
          # Add your CYPRESS_RECORD_KEY in GitHub repo â†’ Settings â†’ Secrets â†’ Actions
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 30

      - name: Upload flaky test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-tests-report
          path: cypress/flaky-tests-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ§ª Cypress Test Results\n\n';
            comment += 'âŒ Some tests failed. Please check the artifacts for details.\n\n';
            
            // Try to read flaky test report
            try {
              if (fs.existsSync('cypress/flaky-tests-report.json')) {
                const report = JSON.parse(fs.readFileSync('cypress/flaky-tests-report.json', 'utf8'));
                comment += `### Flaky Tests Summary\n`;
                comment += `- Total Tests: ${report.summary.totalTests}\n`;
                comment += `- Flaky Tests: ${report.summary.flakyTests}\n`;
                comment += `- Total Retries: ${report.summary.totalRetries}\n\n`;
                
                if (report.summary.flakyTests > 0) {
                  comment += '### Flaky Test Details\n';
                  for (const [testName, data] of Object.entries(report.tests)) {
                    if (data.passedAfterRetry) {
                      comment += `- **${testName}**: Failed ${data.failedAttempts} time(s) before passing\n`;
                    }
                  }
                }
              }
            } catch (e) {
              comment += 'Could not read flaky test report.\n';
            }
            
            comment += '\nðŸ“¹ Check the **Actions** tab for video recordings and screenshots.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Generate HTML report and deploy to GitHub Pages
  report:
    needs: cypress-run
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create HTML report
        run: |
          mkdir -p public
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cypress Test Dashboard</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 2rem;
              }
              .container { max-width: 1200px; margin: 0 auto; }
              .header {
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                margin-bottom: 2rem;
              }
              h1 { color: #2d3748; font-size: 2.5rem; margin-bottom: 0.5rem; }
              .subtitle { color: #718096; font-size: 1.1rem; }
              .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
              }
              .card {
                background: white;
                padding: 1.5rem;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
              }
              .card h2 {
                color: #2d3748;
                margin-bottom: 1rem;
                font-size: 1.3rem;
              }
              .stat {
                display: flex;
                justify-content: space-between;
                padding: 0.75rem;
                margin: 0.5rem 0;
                background: #f7fafc;
                border-radius: 8px;
              }
              .stat-label { color: #4a5568; font-weight: 500; }
              .stat-value { color: #2d3748; font-weight: 700; }
              .success { color: #48bb78; }
              .error { color: #f56565; }
              .warning { color: #ed8936; }
              .artifact-list {
                list-style: none;
                margin-top: 1rem;
              }
              .artifact-list li {
                padding: 0.75rem;
                margin: 0.5rem 0;
                background: #f7fafc;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              }
              .artifact-list a {
                color: #667eea;
                text-decoration: none;
                font-weight: 500;
              }
              .artifact-list a:hover {
                text-decoration: underline;
              }
              .icon { font-size: 1.2rem; }
              .timestamp {
                text-align: center;
                color: white;
                margin-top: 2rem;
                opacity: 0.9;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>ðŸ§ª Cypress Test Dashboard</h1>
                <p class="subtitle">OrangeHRM E2E Test Results</p>
              </div>
              
              <div class="dashboard">
                <div class="card">
                  <h2>ðŸ“Š Test Summary</h2>
                  <div class="stat">
                    <span class="stat-label">Total Tests</span>
                    <span class="stat-value" id="total-tests">Loading...</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Passed</span>
                    <span class="stat-value success" id="passed-tests">-</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Failed</span>
                    <span class="stat-value error" id="failed-tests">-</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Flaky Tests</span>
                    <span class="stat-value warning" id="flaky-tests">-</span>
                  </div>
                </div>

                <div class="card">
                  <h2>ðŸ“¹ Test Artifacts</h2>
                  <ul class="artifact-list">
                    <li>
                      <span class="icon">ðŸŽ¥</span>
                      <a href="#videos">Test Videos</a>
                    </li>
                    <li>
                      <span class="icon">ðŸ“¸</span>
                      <a href="#screenshots">Screenshots</a>
                    </li>
                    <li>
                      <span class="icon">ðŸ“„</span>
                      <a href="#report">Flaky Test Report</a>
                    </li>
                  </ul>
                </div>

                <div class="card">
                  <h2>ðŸ”„ Flaky Test Details</h2>
                  <div id="flaky-details">
                    <p style="color: #718096;">No flaky tests detected</p>
                  </div>
                </div>
              </div>

              <div class="timestamp">
                Last updated: <span id="timestamp"></span>
              </div>
            </div>

            <script>
              document.getElementById('timestamp').textContent = new Date().toLocaleString();
            </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
